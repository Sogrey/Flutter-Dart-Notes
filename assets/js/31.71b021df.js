(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{249:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"【补】异步编程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#【补】异步编程"}},[t._v("#")]),t._v(" 【补】异步编程")]),t._v(" "),s("p",[t._v("Dart与JavaScript的共同点是单线程，同步代码会阻塞程序。因此程序中会看到大量异步操作，使用"),s("code",[t._v("Future")]),t._v("对象来执行相关操作，并且在"),s("code",[t._v("async")]),t._v("函数使用"),s("code",[t._v("await")]),t._v("关键字是才执行，直到一个"),s("code",[t._v("Future")]),t._v("操作完成。"),s("code",[t._v("Future")]),t._v("支持链式操作，可以按顺序执行异步函数。")]),t._v(" "),s("h2",{attrs:{id:"future是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#future是什么"}},[t._v("#")]),t._v(" Future是什么")]),t._v(" "),s("p",[t._v("一个Future是一个Future自身泛型"),s("code",[t._v("Future<T>")]),t._v("对象,表示一个异步操作产生得"),s("code",[t._v("T")]),t._v("类型结果。如果结果值不可用，Future的类型会是"),s("code",[t._v("Future<void>")]),t._v(",如果返回一个Future的函数被调用将会发生：")]),t._v(" "),s("ol",[s("li",[t._v("这个函数加入待完成队列并且返回一个未完成的Future对象")]),t._v(" "),s("li",[t._v("当这个操作结束，Future对象返回一个值或错误")])]),t._v(" "),s("p",[t._v("Future的几种创建方法:")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("Future()")])]),t._v(" "),s("li",[s("code",[t._v("Future.microtask()")])]),t._v(" "),s("li",[s("code",[t._v("Future.sync()")])]),t._v(" "),s("li",[s("code",[t._v("Future.value()")])]),t._v(" "),s("li",[s("code",[t._v("Future.delayed()")])]),t._v(" "),s("li",[s("code",[t._v("Future.error()")])])]),t._v(" "),s("p",[t._v("其中sync是同步方法，任务会被立即执行")]),t._v(" "),s("div",{staticClass:"language-dart extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dart"}},[s("code",[t._v("Future"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("int"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" future "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFuture")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfuture"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleValue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//接受异步处理结果")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("catchError")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleError")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//在异步函数中捕获异常")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("whenComplete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleCpmplete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//无论处理成功还是失败，之后如需还需要处理些事，可以在whenComplete中进行")]),t._v("\n\n")])])]),s("h2",{attrs:{id:"async和await"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#async和await"}},[t._v("#")]),t._v(" async和await")]),t._v(" "),s("p",[t._v("在Dart1.9中加入了"),s("code",[t._v("async")]),t._v("和"),s("code",[t._v("await")]),t._v("关键字，有了这两个关键字，我们可以更简洁的编写异步代码，而不需要调用Future相关的API。他们允许你像写同步代码一样写异步代码和不需要使用Future接口。")]),t._v(" "),s("p",[t._v("将 "),s("code",[t._v("async")]),t._v(" 关键字作为方法声明的后缀时，具有如下意义")]),t._v(" "),s("ul",[s("li",[t._v("被修饰的方法会将一个 Future 对象作为返回值")]),t._v(" "),s("li",[t._v("该方法会同步执行其中的方法的代码直到第一个 "),s("code",[t._v("await")]),t._v(" 关键字，然后它暂停该方法其他部分的执行；")]),t._v(" "),s("li",[t._v("一旦由 await 关键字引用的 Future 任务执行完成，await的下一行代码将立即执行。")])]),t._v(" "),s("p",[t._v("但遇到有需要延迟的运算（async）时，将其放在延迟运算队列（await）里，把不需要延迟运算的部分先执行完，最后再处理延迟运算的部分。但是要是用"),s("code",[t._v("await")]),t._v(",就必须在有"),s("code",[t._v("async")]),t._v("的标记的函数里执行，否则这个"),s("code",[t._v("await")]),t._v("会报错。")]),t._v(" "),s("p",[t._v("与JavaScript很像，"),s("code",[t._v("async")]),t._v("和"),s("code",[t._v("await")]),t._v("是Future的语法糖（Syntactic sugar）,解决回调地狱（Callback Hell）问题。")]),t._v(" "),s("p",[t._v("举一例：")]),t._v(" "),s("div",{staticClass:"language-dart extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dart"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("step1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'step1'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("step1Result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("step2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("step1Result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("step2Result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("step3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("step3Result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("step3Result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...  ")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("使用async-await改写之后：")]),t._v(" "),s("div",{staticClass:"language-dart extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dart"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        String step1Result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("step1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'step1'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        String step2Result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("step1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("step1Result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        String step3Result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("step1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("step1Result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("ul",[s("li",[t._v("当使用async作为方法名后缀声明时，说明这个方法的返回值是一个Future；")]),t._v(" "),s("li",[t._v("当执行到该方法代码用await关键字标注时，会暂停该方法其他部分执行；")]),t._v(" "),s("li",[t._v("当await关键字引用的Future执行完成，下一行代码会立即执行。")])])])}),[],!1,null,null,null);a.default=e.exports}}]);